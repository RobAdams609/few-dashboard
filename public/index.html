<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>The FEW — Dashboard</title>
<style>
  :root{
    --bg:#0f1115; --panel:#151922; --text:#d9dee8; --muted:#9aa4b2;
    --gold:#f5d37b; --gold-2:#c8a74a; --line:#262b36; --green:#1fd08b;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--text);font:16px/1.45 Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
  .wrap{max-width:1200px;margin:0 auto;padding:28px 20px 120px}
  header{margin-bottom:18px}
  h1{margin:0 0 8px;font-size:44px;font-weight:900;letter-spacing:.02em;
     text-align:center;color:#fff;text-shadow:0 0 22px rgba(245,211,123,.28)}
  .subtitle{margin:0 auto;max-width:980px;text-align:center;color:var(--muted)}
  .cards{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:16px;margin:24px 0}
  .card{background:var(--panel);border:1px solid var(--line);border-radius:14px;padding:16px;text-align:center}
  .card .k{font-size:13px;color:var(--muted)}
  .card .v{margin-top:8px;font-weight:800;color:var(--gold);font-size:26px}

  table{width:100%;border-collapse:collapse}
  th,td{border-bottom:1px solid var(--line);padding:12px 10px;text-align:left}
  th{color:#aab3c2;font-size:13px;font-weight:700}
  td.right,th.right{text-align:right}
  .row{background:var(--panel);border:1px solid var(--line);border-radius:14px;overflow:hidden}
  .avatar{width:28px;height:28px;border-radius:50%;background:#253;display:inline-block;vertical-align:middle;margin-right:10px;object-fit:cover}
  .avatar-lg{width:84px;height:84px;border-radius:50%;object-fit:cover;border:3px solid #1c2230}

  /* sale overlay */
  .sale-overlay{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,.55);z-index:9999;opacity:0;pointer-events:none;transition:opacity .25s}
  .sale-overlay.show{opacity:1;pointer-events:auto}
  .sale-card{min-width:min(900px,90vw);padding:min(36px,4vw);text-align:center;background:linear-gradient(180deg,#3a2b00,#0f0f0f);
    border:3px solid var(--gold-2);border-radius:18px;box-shadow:0 0 0 4px rgba(200,167,74,.25),0 24px 64px rgba(0,0,0,.6)}
  .sale-chip{display:inline-block;font-weight:800;letter-spacing:.12em;text-transform:uppercase;border:2px solid var(--gold-2);color:var(--gold);padding:.4rem .8rem;border-radius:999px;margin-bottom:10px}
  .sale-name{font-size:min(56px,8vw);color:#fff;margin:.25rem 0}
  .sale-amount{font-size:min(44px,6vw);color:var(--gold);font-weight:900}

  /* donut */
  .donut-wrap{display:flex;gap:28px;align-items:center;flex-wrap:wrap}
  .donut-legend{display:grid;grid-template-columns:16px 1fr auto;gap:10px 14px;align-items:center}
  .donut-swatch{width:16px;height:16px;border-radius:3px}

  .muted{color:var(--muted)}
  .kpi{display:flex;gap:18px;align-items:center;flex-wrap:wrap}
  .pill{border:1px solid var(--line);border-radius:999px;padding:6px 10px;color:var(--muted);font-size:13px}
  .footer{position:fixed;left:0;right:0;bottom:14px;display:flex;justify-content:center;pointer-events:none}
  .countdown{pointer-events:auto;min-width:320px;border-radius:42px;border:2px solid #234;box-shadow:inset 0 0 0 2px rgba(31,208,139,.15);padding:10px 18px;background:rgba(15,23,32,.8)}
  .countdown b{color:var(--green)}
  @media (max-width:900px){
    h1{font-size:34px}
    .cards{grid-template-columns:1fr}
  }
</style>
</head>
<body>
<div class="wrap">
  <header>
    <h1 id="titleText">THE FEW — EVERYONE WANTS TO EAT BUT FEW WILL HUNT</h1>
    <p class="subtitle" id="subtitleText"></p>
  </header>

  <section class="cards">
    <div class="card"><div class="k">This Week — Team Calls</div><div class="v" id="kpiCalls">0</div></div>
    <div class="card"><div class="k">This Week — Total Submitted AV</div><div class="v" id="kpiAV">$0</div></div>
    <div class="card"><div class="k">This Week — Deals Submitted</div><div class="v" id="kpiDeals">0</div></div>
  </section>

  <div id="board" class="row">
    <table>
      <thead id="thead"></thead>
      <tbody id="tbody"></tbody>
    </table>
  </div>
</div>

<!-- sale overlay -->
<div class="sale-overlay" id="saleOverlay">
  <div class="sale-card">
    <div class="sale-chip">NEW SALE</div>
    <div class="sale-name" id="saleName"></div>
    <div class="sale-amount" id="saleAmount"></div>
  </div>
</div>

<div class="footer"><div class="countdown">OE Countdown&nbsp;&nbsp;<b id="oeTimer">—</b></div></div>

<script>
/* =========================
   CONFIG + UTILITIES
========================= */
const TITLE_TEXT = "THE FEW — EVERYONE WANTS TO EAT BUT FEW WILL HUNT";
const ROTATION = ["this_week_roster","agent_of_week","vendors_45d","agent_activity","ytd_team","par_board"];

const HEADSHOT_MAP = {
  "Philip Baxter":"philip_baxter.jpg",
  "Fabricio Navarrete":"fabricio_navarrete.jpg",
  "Robert Adams":"robert_adams.jpg",
  "Nathan Johnson":"nathan_johnson.jpg",
  // add more filenames as needed
};

const ALIASES = new Map([
  ["F N","Fabricio Navarrete"],
  ["FABRICIO NAVARRETE CERVANTES","Fabricio Navarrete"],
  ["FABRICIO NAVARRETE","Fabricio Navarrete"],
]);

const money = n => `$${(Math.round((+n||0))).toLocaleString()}`;
const num = n => (+n||0);
function canon(name){ if(!name) return ""; const k=name.trim().toUpperCase(); return ALIASES.get(k)||name.trim(); }
function headshot(name){ const f=HEADSHOT_MAP[canon(name)]; return f?`./headshots/${f}`:null; }
function hashColor(str){ let h=0; for(let i=0;i<str.length;i++) h=(h*31+str.charCodeAt(i))|0; const hue=Math.abs(h)%360; return `hsl(${hue} 70% 48%)`; }

let RULES=[], ruleIdx=0;
async function loadRules(){ try{ RULES = await (await fetch("./rules.json")).json(); }catch{ RULES=[]; } }
function renderBanner(){ document.getElementById("titleText").textContent = TITLE_TEXT;
  document.getElementById("subtitleText").textContent = RULES.length? RULES[ruleIdx%RULES.length] : ""; }

function tickRules(){ ruleIdx++; renderBanner(); }

/* =========================
   DATA LOAD
========================= */
let cache={};
async function j(url){ if(cache[url]) return cache[url]; const r=await fetch(url); const d=await r.json(); cache[url]=d; return d; }
async function getTeam(){ return j("/api/team_sold"); }         // {team, perAgent, allSales}
async function getCalls(){ return j("/api/calls_by_agent"); }    // {perAgent:[{name,calls,talkMin,loggedMin}]}
async function getLeads(){ try{ return j("/api/leads_by_agent"); }catch{ return {perAgent:[]}; } }
async function getYTD(){ try{ const d=await (await fetch("./overrides/ytd_av.json")).json(); const m=new Map(Object.entries(d).map(([k,v])=>[canon(k),num(v)])); return m; }catch{ return new Map(); } }
async function getPAR(){ try{ const arr=await (await fetch("./overrides/par.json")).json(); return arr.map(x=>({name:canon(x.name),note:x.note||""})); }catch{ return []; } }

/* =========================
   KPI SUMMARY
========================= */
async function renderKPIs(){
  const [t,c] = await Promise.all([getTeam(), getCalls()]);
  const calls = (c?.team?.calls)||0;
  const av = (t?.team?.totalAV12x) || (t?.team?.totalAmount*12) || (t?.team?.totalAmount) || 0; // fallback
  const deals = (t?.team?.totalSales) || 0;
  document.getElementById("kpiCalls").textContent = calls.toLocaleString();
  document.getElementById("kpiAV").textContent = money(av);
  document.getElementById("kpiDeals").textContent = deals.toLocaleString();
}

/* =========================
   BOARD RENDERERS
========================= */
const thead = document.getElementById("thead");
const tbody = document.getElementById("tbody");

function setHead(cols){
  thead.innerHTML = `<tr>${cols.map(c=>`<th class="${c.right?'right':''}">${c.label}</th>`).join("")}</tr>`;
}

function rowAgentCell(name){
  const img=headshot(name);
  return `<div style="display:flex;align-items:center;gap:10px">
    <img class="avatar" src="${img||'./headshots/initials.png'}" alt="">
    <span>${canon(name)}</span>
  </div>`;
}

/* Roster: this week submitted AV + deals */
async function boardRoster(){
  const t = await getTeam();
  const rows = (t?.perAgent||[]).map(r=>({
    name: canon(r.name), av: num(r.av12x)||num(r.amount)||0, deals: num(r.sales)||0
  })).sort((a,b)=> b.av-a.av);
  setHead([{label:"Agent"},{label:"Submitted AV",right:true},{label:"Deals",right:true}]);
  tbody.innerHTML = rows.map(r=>`<tr>
    <td>${rowAgentCell(r.name)}</td>
    <td class="right">${money(r.av)}</td>
    <td class="right">${r.deals}</td>
  </tr>`).join("");
}

/* Agent of Week */
async function boardAOW(){
  const [t,ytd] = await Promise.all([getTeam(), getYTD()]);
  const list=(t?.perAgent||[]).map(r=>({name:canon(r.name),deals:num(r.sales)||0,av:num(r.av12x)||num(r.amount)||0}));
  const leader = list.sort((a,b)=> b.av-a.av)[0];
  setHead([{label:"Leader"},{label:""}]);
  if(!leader){ tbody.innerHTML=`<tr><td>No data.</td><td></td></tr>`; return; }
  const img=headshot(leader.name);
  tbody.innerHTML = `<tr>
    <td colspan="2">
      <div style="display:flex;gap:18px;align-items:center;padding:18px">
        <img class="avatar-lg" src="${img||'./headshots/initials.png'}" alt="">
        <div>
          <h2 style="margin:0 0 6px">${leader.name}</h2>
          <div class="muted" style="margin-bottom:8px">LEADING FOR AGENT OF THE WEEK</div>
          <div class="kpi">
            <span class="pill"><b>${leader.deals}</b>&nbsp;deals (this week)</span>
            <span class="pill" style="color:var(--gold)"><b>${money(leader.av)}</b>&nbsp;submitted AV (this week)</span>
            <span class="pill"><b>${money(ytd.get(leader.name)||0)}</b>&nbsp;YTD AV</span>
          </div>
        </div>
      </div>
    </td>
  </tr>`;
}

/* Vendors donut (45d) */
function donutSVG(parts){
  const R=80,C=R+4,W=24,CIRC=2*Math.PI*R;
  let acc=0, arcs="";
  parts.forEach(p=>{
    const len=CIRC*p.frac;
    arcs += `<circle r="${R}" cx="${C}" cy="${C}" fill="transparent" stroke="${p.color}" stroke-width="${W}"
              stroke-dasharray="${len} ${CIRC-len}" stroke-dashoffset="${-acc}"></circle>`;
    acc += len;
  });
  return `<svg width="${C*2}" height="${C*2}" viewBox="0 0 ${C*2} ${C*2}">
    <circle r="${R}" cx="${C}" cy="${C}" fill="transparent" stroke="#222" stroke-width="${W}"/>${arcs}</svg>`;
}
async function boardVendors(){
  const t = await getTeam();
  const map=new Map();
  (t?.allSales||[]).forEach(s=>{
    const v=s.soldProductName||"Unknown";
    map.set(v,(map.get(v)||0)+1);
  });
  const rows=[...map.entries()].map(([vendor,deals])=>({vendor,deals})).sort((a,b)=>b.deals-a.deals);
  setHead([{label:"Lead Vendors — Last 45 Days"},{label:"Deals",right:true},{label:"% of total",right:true}]);
  if(!rows.length){ tbody.innerHTML=`<tr><td>No vendor data yet.</td><td></td><td></td></tr>`; return; }
  const total=rows.reduce((a,r)=>a+r.deals,0);
  const parts=rows.map(r=>({label:r.vendor, frac:r.deals/total, color:hashColor(r.vendor)}));
  const svg=donutSVG(parts);
  const legend=rows.map(r=>`
    <div class="donut-swatch" style="background:${hashColor(r.vendor)}"></div>
    <div>${r.vendor}</div>
    <div class="right">${r.deals} (${Math.round(100*r.deals/total)}%)</div>`).join("");
  tbody.innerHTML = `<tr><td colspan="3">
    <div class="donut-wrap">
      <div>${svg}</div>
      <div class="donut-legend" style="min-width:260px">${legend}</div>
    </div>
  </td></tr>`;
}

/* Agent Activity (Calls/Talk/Logged/Leads/Sold/Conv%) */
async function boardActivity(){
  const [t,c,l] = await Promise.all([getTeam(),getCalls(),getLeads()]);
  const calls=new Map(), talk=new Map(), logged=new Map(), leads=new Map(), sold=new Map();

  (c?.perAgent||[]).forEach(r=>{ const n=canon(r.name);
    calls.set(n,(calls.get(n)||0)+num(r.calls));
    talk.set(n,(talk.get(n)||0)+num(r.talkMin));
    logged.set(n,(logged.get(n)||0)+num(r.loggedMin));
  });
  (l?.perAgent||[]).forEach(r=>{ const n=canon(r.name); leads.set(n,(leads.get(n)||0)+num(r.leads||r.count)); });
  (t?.perAgent||[]).forEach(r=>{ const n=canon(r.name); sold.set(n,(sold.get(n)||0)+num(r.sales)); });

  const names=new Set([...calls.keys(),...leads.keys(),...sold.keys()]);
  const rows=[...names].map(n=>{
    const C=calls.get(n)||0, L=leads.get(n)||0, S=sold.get(n)||0;
    return {name:n, calls:C, talk:talk.get(n)||0, logged:logged.get(n)||0, leads:L, sold:S, conv: L? (S/L):0};
  }).sort((a,b)=> b.sold-a.sold || b.calls-a.calls);

  setHead([{label:"Agent"},{label:"Calls",right:true},{label:"Talk (min)",right:true},{label:"Logged (h:mm)",right:true},{label:"Leads",right:true},{label:"Sold",right:true},{label:"Conv %",right:true}]);

  function minToHM(m){ const h=Math.floor(m/60), mm=Math.round(m%60); return `${h}:${String(mm).padStart(2,"0")}`; }

  tbody.innerHTML = rows.map(r=>`<tr>
    <td>${rowAgentCell(r.name)}</td>
    <td class="right">${r.calls.toLocaleString()}</td>
    <td class="right">${Math.round(r.talk)}</td>
    <td class="right">${minToHM(r.logged)}</td>
    <td class="right">${r.leads}</td>
    <td class="right">${r.sold}</td>
    <td class="right">${Math.round(r.conv*100)}%</td>
  </tr>`).join("");
}

/* YTD Team */
async function boardYTD(){
  const ytd = await getYTD();
  const rows=[...ytd.entries()].map(([name,amt])=>({name,amt})).sort((a,b)=>b.amt-a.amt);
  setHead([{label:"Agent"},{label:"YTD AV",right:true}]);
  tbody.innerHTML = rows.map(r=>`<tr>
    <td>${rowAgentCell(r.name)}</td>
    <td class="right">${money(r.amt)}</td>
  </tr>`).join("");
}

/* PAR board (manual override) */
async function boardPAR(){
  const list = await getPAR();
  setHead([{label:"PAR — On Track"},{label:"Note"}]);
  if(!list.length){ tbody.innerHTML=`<tr><td>No PAR list provided.</td><td></td></tr>`; return; }
  tbody.innerHTML = list.map(x=>`<tr>
    <td>${rowAgentCell(x.name)}</td>
    <td>${x.note||""}</td>
  </tr>`).join("");
}

/* =========================
   SALE OVERLAY (call showSale when a sale is detected)
========================= */
const overlay = document.getElementById("saleOverlay");
let saleTimer=null;
function showSale(name, amount){
  document.getElementById("saleName").textContent = canon(name);
  document.getElementById("saleAmount").textContent = money(amount);
  overlay.classList.add("show");
  clearTimeout(saleTimer); saleTimer=setTimeout(()=>overlay.classList.remove("show"), 60000);
}

/* Example hook:
   // whenever your websocket/poll detects a new sale:
   showSale("Fabricio Navarrete", 7392);
*/

/* =========================
   ROTATION + INIT
========================= */
let rotIdx=0;
async function renderCurrent(){
  await renderKPIs();
  const kind = ROTATION[rotIdx % ROTATION.length];
  if(kind==="this_week_roster") await boardRoster();
  else if(kind==="agent_of_week") await boardAOW();
  else if(kind==="vendors_45d") await boardVendors();
  else if(kind==="agent_activity") await boardActivity();
  else if(kind==="ytd_team") await boardYTD();
  else if(kind==="par_board") await boardPAR();
}

function startRotation(){
  renderCurrent();
  setInterval(()=>{ rotIdx++; renderCurrent(); }, 20000);
}

function startRuleRotation(){ setInterval(tickRules, 15000); }

/* simple OE countdown demo */
function startOE(){
  const el=document.getElementById("oeTimer");
  function tick(){
    // set your target end date/time here if needed
    el.textContent = new Date(Date.now()+5*24*3600*1000 + 14*3600*1000 + 4*60*1000+49*1000).toISOString().substring(11,19).replace("T"," ");
  }
  tick(); setInterval(tick,1000);
}

/* Boot */
(async function(){
  await loadRules(); renderBanner(); startRuleRotation();
  startOE();
  startRotation();
})();
</script>
</body>
</html>
